<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Admin Dashboard - SMK Muhammadiyah Bandongan</title>
    
    <!-- PWA MANIFEST & THEME -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <link rel="apple-touch-icon" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiN3lb6zD8UmdVfbhENgNWXK1OjWDvwrZVUaEyMyjcOIxgzqIu5wzGUZusOD9WYXVVupp87PQ4lZcZl6ZyzPtFe8h4-TnjMLz31oDylO9UScGA0bi_miR8MKYufzevuezpGhNrpaOrgixQiPBkS9iZb8JalBVD5ueOhN4TB9x3T9N2yG4rwjEdDUGkoK0k/s554/images%20(2).png">

    <!-- STYLES & FONTS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- LIBRARIES (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <script>
        // CONFIG
        const TURNSTILE_SITE_KEY = "0x4AAAAAACEvm2Gj39aZbQKD";
        let loginWidgetId = null;

        window.onAdminTurnstileLoad = function() {
            loginWidgetId = turnstile.render('#login-turnstile', {
                sitekey: TURNSTILE_SITE_KEY
            });
        };
    </script>
    <!-- Cloudflare Turnstile -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=onAdminTurnstileLoad" async defer></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; color: #0f172a; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .hidden { display: none !important; }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #0f172a; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #admin-sidebar { transition: transform 0.3s ease-in-out; }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
    </style>
</head>
<body>

    <!-- ======================= LOGIN PAGE ======================= -->
    <div id="page-login" class="min-h-screen bg-[#F0F6FF] flex flex-col items-center justify-center p-4">
        <div class="max-w-md w-full">
            <div class="text-center mb-8">
                <div class="flex justify-center mb-4">
                    <div class="w-20 h-20 bg-white rounded-full shadow-lg shadow-blue-100 flex items-center justify-center p-2">
                        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiN3lb6zD8UmdVfbhENgNWXK1OjWDvwrZVUaEyMyjcOIxgzqIu5wzGUZusOD9WYXVVupp87PQ4lZcZl6ZyzPtFe8h4-TnjMLz31oDylO9UScGA0bi_miR8MKYufzevuezpGhNrpaOrgixQiPBkS9iZb8JalBVD5ueOhN4TB9x3T9N2yG4rwjEdDUGkoK0k/s554/images%20(2).png" alt="Logo" class="w-full h-full object-contain">
                    </div>
                </div>
                <h1 class="text-2xl font-bold text-slate-900">Admin Login</h1>
                <p class="text-slate-500 text-sm mt-1">Silakan masuk untuk mengakses dashboard</p>
            </div>
            
            <div class="bg-white rounded-[2rem] shadow-xl shadow-blue-100/50 p-8 border border-white">
                <form id="login-form" class="space-y-5">
                    <div id="login-error" class="hidden bg-red-50 text-red-600 p-3 rounded-xl text-sm border border-red-100 flex items-center">
                        <i data-lucide="alert-circle" class="w-4 h-4 mr-2 flex-shrink-0"></i>
                        <span id="login-error-text">Login gagal</span>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Username</label>
                        <div class="relative">
                            <i data-lucide="user" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
                            <input type="text" id="login-username" class="w-full pl-11 pr-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition text-slate-900 placeholder:text-slate-400" placeholder="Username admin" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Password</label>
                        <div class="relative">
                            <i data-lucide="key" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
                            <input type="password" id="login-password" class="w-full pl-11 pr-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition text-slate-900 placeholder:text-slate-400" placeholder="Password admin" required>
                        </div>
                    </div>
                    
                    <!-- Turnstile for Login -->
                    <div class="flex justify-center">
                        <div id="login-turnstile"></div>
                    </div>
                    
                    <button type="submit" id="btn-login" class="w-full py-3.5 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800 transition shadow-lg shadow-slate-200 flex items-center justify-center mt-4">
                        <span id="btn-login-text">Masuk Dashboard</span>
                        <div id="btn-login-loader" class="loader ml-2 hidden border-white border-t-transparent"></div>
                    </button>
                </form>
            </div>
            <div class="mt-8 text-center">
                <a href="https://bukutamusmkmbandongan.rf.gd" class="text-slate-500 text-sm font-medium hover:text-slate-800 transition flex items-center justify-center mx-auto py-2 px-4 rounded-lg hover:bg-white">
                    <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i> Kembali ke Halaman Tamu
                </a>
            </div>
        </div>
    </div>

    <!-- ======================= ADMIN PAGE ======================= -->
    <div id="page-admin" class="hidden min-h-screen bg-[#F1F5F9] relative">
        
        <!-- SIDEBAR OVERLAY (MOBILE) -->
        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-slate-900/50 z-40 hidden md:hidden"></div>

        <!-- SIDEBAR -->
        <aside id="admin-sidebar" class="bg-white fixed inset-y-0 left-0 w-64 border-r border-slate-200 flex flex-col z-50 transform -translate-x-full md:translate-x-0">
            <div class="p-6 border-b border-slate-100 flex items-center gap-3">
                <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiN3lb6zD8UmdVfbhENgNWXK1OjWDvwrZVUaEyMyjcOIxgzqIu5wzGUZusOD9WYXVVupp87PQ4lZcZl6ZyzPtFe8h4-TnjMLz31oDylO9UScGA0bi_miR8MKYufzevuezpGhNrpaOrgixQiPBkS9iZb8JalBVD5ueOhN4TB9x3T9N2yG4rwjEdDUGkoK0k/s554/images%20(2).png" alt="Logo" class="w-10 h-10 object-contain">
                <div>
                    <h1 class="text-sm font-bold text-slate-900 leading-tight">Admin Panel</h1>
                    <p class="text-[10px] text-slate-500">v3.1 Premium</p>
                </div>
            </div>
            
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <button onclick="renderAdminPage('dashboard'); toggleSidebar(false)" id="nav-dashboard" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium transition bg-slate-100 text-slate-900">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    Dashboard
                </button>
                <button onclick="renderAdminPage('premium'); toggleSidebar(false)" id="nav-premium" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium text-slate-500 hover:bg-slate-50 hover:text-slate-900 transition">
                    <i data-lucide="sparkles" class="w-5 h-5 text-amber-500"></i>
                    Fitur Premium
                </button>
            </nav>

            <div class="p-4 border-t border-slate-100">
                <button onclick="handleLogout()" class="w-full flex items-center justify-center gap-2 px-4 py-2.5 border border-red-100 bg-red-50 text-red-600 rounded-xl hover:bg-red-100 transition font-medium text-sm">
                    <i data-lucide="log-out" class="w-4 h-4"></i> Logout
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT WRAPPER -->
        <div class="md:pl-64 flex flex-col min-h-screen transition-all">
            
            <!-- ADMIN HEADER -->
            <header class="bg-white border-b border-slate-200 sticky top-0 z-30 px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="md:hidden p-2 -ml-2 hover:bg-slate-100 rounded-lg text-slate-600">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                    <!-- Plan Badge (Dynamic) -->
                    <div id="plan-badge" class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold bg-slate-100 text-slate-600 border border-slate-200">
                        <i data-lucide="loader" class="w-3.5 h-3.5 animate-spin"></i> Checking...
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="text-right mr-2 hidden sm:block">
                        <div class="text-sm font-bold text-slate-900">Administrator</div>
                        <div class="text-[10px] text-slate-500">Logged in</div>
                    </div>
                    <div class="w-9 h-9 bg-slate-900 text-white rounded-full flex items-center justify-center font-bold text-sm">A</div>
                </div>
            </header>

            <!-- PAGE CONTENT -->
            <main class="flex-1 p-4 md:p-8 bg-slate-50">
                <!-- TAB: DASHBOARD -->
                <div id="admin-view-dashboard" class="max-w-6xl mx-auto space-y-8 animate-fade-in">
                    <!-- Welcome Banner -->
                    <div class="bg-slate-900 rounded-2xl p-6 md:p-8 text-white relative overflow-hidden shadow-xl shadow-slate-200">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-full -translate-y-1/2 translate-x-1/3"></div>
                        <div class="relative z-10">
                            <h2 class="text-2xl font-bold mb-2">Selamat Datang di Panel Admin</h2>
                            <p class="text-slate-300 max-w-xl">Pantau data kunjungan tamu secara real-time, unduh laporan, dan kelola arsip buku tamu digital sekolah dengan mudah.</p>
                        </div>
                    </div>

                    <!-- Stats Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5">
                        <!-- Total -->
                        <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-start justify-between">
                            <div>
                                <p class="text-sm font-medium text-slate-500 mb-1">Total Tamu</p>
                                <h3 id="stat-total" class="text-3xl font-bold text-slate-900">0</h3>
                                <p class="text-xs text-slate-400 mt-2">Semua waktu</p>
                            </div>
                            <div class="p-3 bg-blue-50 rounded-xl text-blue-600">
                                <i data-lucide="users" class="w-6 h-6"></i>
                            </div>
                        </div>
                        <!-- Today -->
                        <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-start justify-between">
                            <div>
                                <p class="text-sm font-medium text-slate-500 mb-1">Hari Ini</p>
                                <h3 id="stat-today" class="text-3xl font-bold text-slate-900">0</h3>
                                <p class="text-xs text-green-500 mt-2 flex items-center font-medium"><i data-lucide="calendar" class="w-3 h-3 mr-1"></i> Data baru</p>
                            </div>
                            <div class="p-3 bg-green-50 rounded-xl text-green-600">
                                <i data-lucide="clock" class="w-6 h-6"></i>
                            </div>
                        </div>
                        <!-- Month -->
                        <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-start justify-between">
                            <div>
                                <p class="text-sm font-medium text-slate-500 mb-1">Bulan Ini</p>
                                <h3 id="stat-month" class="text-3xl font-bold text-slate-900">0</h3>
                                <p class="text-xs text-slate-400 mt-2">Akumulasi bulan ini</p>
                            </div>
                            <div class="p-3 bg-purple-50 rounded-xl text-purple-600">
                                <i data-lucide="bar-chart-3" class="w-6 h-6"></i>
                            </div>
                        </div>
                        <!-- Completion -->
                        <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-start justify-between">
                            <div>
                                <p class="text-sm font-medium text-slate-500 mb-1">Kelengkapan</p>
                                <div class="flex gap-4 mt-2">
                                    <div>
                                        <span id="stat-photo" class="block text-xl font-bold text-slate-900">0</span>
                                        <span class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Foto</span>
                                    </div>
                                    <div class="w-px bg-slate-100 h-8"></div>
                                    <div>
                                        <span id="stat-sign" class="block text-xl font-bold text-slate-900">0</span>
                                        <span class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">TTD</span>
                                    </div>
                                </div>
                            </div>
                            <div class="p-3 bg-orange-50 rounded-xl text-orange-600">
                                <i data-lucide="file-check" class="w-6 h-6"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Main Content Area -->
                    <div class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden">
                        <!-- Toolbar -->
                        <div class="p-5 border-b border-slate-100 flex flex-col sm:flex-row gap-4 justify-between items-center bg-white">
                            <h3 class="text-lg font-bold text-slate-800 flex items-center">
                                <i data-lucide="database" class="w-5 h-5 mr-2 text-slate-400"></i>
                                Data Buku Tamu
                            </h3>
                            
                            <div class="flex gap-3 w-full sm:w-auto">
                                <div class="relative flex-1 sm:w-64">
                                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                                    <input type="text" id="admin-search" onkeyup="filterAdminData()" placeholder="Cari nama atau instansi..." class="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm text-slate-900 focus:bg-white focus:border-blue-500 outline-none transition">
                                </div>
                                <button onclick="fetchAdminData()" class="p-2 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 text-slate-600 transition" title="Refresh Data">
                                    <i data-lucide="refresh-cw" id="refresh-icon" class="w-4 h-4"></i>
                                </button>
                                <button onclick="exportCSV()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium flex items-center transition shadow-sm">
                                    <i data-lucide="download" class="w-4 h-4 mr-2"></i> Export CSV
                                </button>
                            </div>
                        </div>

                        <!-- Table Content -->
                        <div class="relative min-h-[300px]">
                            <!-- Loading State -->
                            <div id="admin-loading" class="absolute inset-0 bg-white z-10 flex flex-col items-center justify-center hidden">
                                <div class="loader w-10 h-10 text-blue-600 border-blue-600 border-t-transparent mb-3"></div>
                                <p class="text-slate-500 text-sm font-medium">Memuat data...</p>
                            </div>
                            <!-- Empty State -->
                            <div id="admin-empty" class="absolute inset-0 bg-white z-0 flex flex-col items-center justify-center hidden">
                                <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-4">
                                    <i data-lucide="inbox" class="w-8 h-8 text-slate-300"></i>
                                </div>
                                <p class="text-slate-900 font-medium">Belum ada data tamu</p>
                                <p class="text-slate-500 text-sm">Data yang masuk akan muncul di sini</p>
                            </div>
                            <!-- Table -->
                            <div id="admin-table-container" class="overflow-x-auto">
                                <table class="w-full text-left border-collapse">
                                    <thead class="bg-slate-50 border-b border-slate-200">
                                        <tr>
                                            <th class="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Nama / Instansi</th>
                                            <th class="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider hidden sm:table-cell">Keperluan</th>
                                            <th class="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider hidden md:table-cell">Waktu</th>
                                            <th class="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider text-center">Dokumen</th>
                                            <th class="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider text-right">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-tbody" class="divide-y divide-slate-100 bg-white">
                                        <!-- Rows injected via JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Pagination / Footer -->
                        <div class="p-4 border-t border-slate-100 bg-slate-50 flex justify-between items-center text-xs text-slate-500">
                            <span>Menampilkan semua data terbaru</span>
                            <a href="https://bukutamusmkmbandongan.rf.gd" class="hover:text-blue-600 font-medium transition">Lihat Halaman Tamu &rarr;</a>
                        </div>
                    </div>
                </div>

                <!-- TAB: PREMIUM FEATURES -->
                <div id="admin-view-premium" class="max-w-4xl mx-auto space-y-6 hidden animate-fade-in">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900 flex items-center gap-2">
                                Fitur Premium
                                <i data-lucide="sparkles" class="w-5 h-5 text-amber-500"></i>
                            </h2>
                            <p class="text-slate-500 text-sm mt-1">Alat canggih untuk efisiensi operasional tamu.</p>
                        </div>
                    </div>

                    <!-- Locked Alert -->
                    <div id="premium-locked-msg" class="hidden bg-slate-800 text-white p-6 rounded-2xl shadow-xl flex items-start gap-4 mb-6 relative overflow-hidden">
                        <div class="absolute -right-4 -top-4 w-24 h-24 bg-white/10 rounded-full"></div>
                        <div class="p-3 bg-white/10 rounded-xl">
                            <i data-lucide="lock" class="w-6 h-6 text-white"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg mb-1">Akses Premium Terkunci</h3>
                            <p class="text-slate-300 text-sm mb-4 max-w-lg">Fitur Layanan Prioritas hanya tersedia untuk akun Premium. Hubungi Developer untuk upgrade.</p>
                            <a href="https://wa.me/6283199105445" target="_blank" class="inline-flex items-center px-4 py-2 bg-white text-slate-900 rounded-lg text-sm font-bold hover:bg-slate-100 transition">
                                <i data-lucide="message-circle" class="w-4 h-4 mr-2"></i> Hubungi Developer
                            </a>
                        </div>
                    </div>

                    <div id="premium-content" class="space-y-6 relative">
                         <!-- Overlay for Locked State -->
                        <div id="premium-overlay" class="hidden absolute inset-0 bg-slate-50/70 z-10 cursor-not-allowed backdrop-blur-sm rounded-2xl"></div>

                        <!-- 3. Support Service -->
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 md:p-8">
                             <div class="flex items-center gap-3 mb-4">
                                <div class="p-2 bg-green-100 text-green-600 rounded-lg"><i data-lucide="headset" class="w-6 h-6"></i></div>
                                <h3 class="text-lg font-bold text-slate-900">Layanan Customer Service</h3>
                            </div>
                            <p class="text-slate-500 text-sm mb-6">Hubungi Developer langsung untuk kendala teknis atau request fitur khusus.</p>
                            
                            <form id="support-form" class="space-y-4">
                                <textarea id="support-msg" rows="3" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-900 placeholder:text-slate-400 focus:bg-white focus:border-blue-500 outline-none resize-none" placeholder="Tulis pesan Anda kepada developer..."></textarea>
                                <div class="flex justify-between items-center">
                                    <a href="https://wa.me/6283199105445" target="_blank" class="text-sm font-medium text-green-600 hover:text-green-700 flex items-center">
                                        <i data-lucide="message-circle" class="w-4 h-4 mr-2"></i> Chat via WhatsApp
                                    </a>
                                    <button type="submit" id="btn-send-support" class="px-6 py-2 bg-slate-900 text-white text-sm font-bold rounded-lg hover:bg-slate-800 transition">
                                        Kirim Pesan
                                    </button>
                                </div>
                            </form>
                        </div>

                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- COPYRIGHT -->
    <div class="hidden md:block fixed bottom-4 right-6 text-right pointer-events-none z-50 opacity-50">
        <p class="text-[10px] text-slate-400">Powered by Student Innovation</p>
    </div>

    <!-- DETAIL MODAL -->
    <div id="detail-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeDetailModal()"></div>
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full relative z-10 flex flex-col max-h-[90vh]">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800 flex items-center"><i data-lucide="user-check" class="w-5 h-5 mr-2 text-blue-600"></i> Detail Tamu</h3>
                <button onclick="closeDetailModal()" class="p-2 hover:bg-slate-100 rounded-full transition text-slate-500"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <div><label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">Foto Dokumentasi</label><div class="rounded-xl overflow-hidden border border-slate-200 bg-slate-50 shadow-sm aspect-[4/3]"><img id="detail-img" src="" class="w-full h-full object-cover"></div></div>
                        <div><label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">Tanda Tangan</label><div class="rounded-xl overflow-hidden border border-slate-200 bg-white p-4 shadow-sm h-32 flex items-center justify-center"><img id="detail-sign" src="" class="max-w-full max-h-full"></div></div>
                    </div>
                    <div class="space-y-5">
                        <div><label class="text-xs font-bold text-slate-400 uppercase tracking-wider block mb-1">Nama Lengkap</label><p id="detail-nama" class="text-lg font-bold text-slate-900"></p></div>
                        <div><label class="text-xs font-bold text-slate-400 uppercase tracking-wider block mb-1">Asal Instansi</label><p id="detail-instansi" class="text-base text-slate-700"></p></div>
                        <div><label class="text-xs font-bold text-slate-400 uppercase tracking-wider block mb-1">Waktu Kehadiran</label><p id="detail-waktu" class="text-sm font-medium text-slate-600 bg-slate-50 px-3 py-1.5 rounded-lg inline-block border border-slate-100"></p></div>
                        <div class="pt-4 border-t border-slate-100"><label class="text-xs font-bold text-slate-400 uppercase tracking-wider block mb-2">Maksud & Tujuan</label><div class="bg-slate-50 p-4 rounded-xl border border-slate-200"><p id="detail-maksud" class="text-sm text-slate-700 leading-relaxed"></p></div></div>
                        <div><label class="text-xs font-bold text-slate-400 uppercase tracking-wider block mb-2">Kesan & Pesan</label><div class="bg-blue-50 p-4 rounded-xl border border-blue-100"><p id="detail-pesan" class="text-sm text-blue-900 leading-relaxed"></p></div></div>
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 bg-slate-50 rounded-b-2xl border-t border-slate-100 flex justify-end"><button onclick="closeDetailModal()" class="px-5 py-2 bg-slate-900 text-white rounded-lg font-medium hover:bg-slate-800 transition">Tutup</button></div>
        </div>
    </div>

    <!-- Delete Modal (POPUP) -->
    <div id="delete-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeDeleteModal()"></div>
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 relative z-10 transform transition-all scale-100">
            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mb-4 mx-auto"><i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i></div>
            <h3 class="text-xl font-bold text-slate-900 text-center mb-2">Hapus Data Ini?</h3>
            <p class="text-slate-500 text-center text-sm mb-6">Tindakan ini tidak dapat dibatalkan. Data tamu beserta foto dan tanda tangan akan dihapus permanen.</p>
            <div class="flex gap-3">
                <button onclick="closeDeleteModal()" class="flex-1 py-2.5 bg-white border border-slate-200 rounded-xl text-slate-700 font-medium hover:bg-slate-50 transition">Batal</button>
                <button id="btn-confirm-delete" onclick="executeDelete()" class="flex-1 py-2.5 bg-red-600 text-white rounded-xl font-medium hover:bg-red-700 shadow-lg shadow-red-200 transition flex items-center justify-center">Ya, Hapus</button>
            </div>
        </div>
    </div>

    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW Admin registered:', registration);
                    })
                    .catch(error => {
                        console.log('SW Admin registration failed:', error);
                    });
            });
        }
    </script>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = "https://nvegzmpajoaryegqbunj.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52ZWd6bXBham9hcnllZ3FidW5qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDk5MzMsImV4cCI6MjA3OTcyNTkzM30.NSx3E9zJcgR-k2OTJWLM820ilZ3TVYZs6npjc0y5ADU";
        const SUPABASE_TABLE = "userdata";
        const SUPABASE_ADMIN_TABLE = "admin";
        
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let adminData = [];
        let idToDelete = null;
        let isSidebarOpen = false;
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            if (typeof lucide !== 'undefined') lucide.createIcons();
            
            // Check Router
            const token = localStorage.getItem('adminToken');
            if (token) {
                showAdminDashboard();
            } else {
                showLoginPage();
            }
        });

        // --- NAVIGATION ---
        function showLoginPage() {
            document.getElementById('page-login').classList.remove('hidden');
            document.getElementById('page-admin').classList.add('hidden');
        }

        function showAdminDashboard() {
            document.getElementById('page-login').classList.add('hidden');
            document.getElementById('page-admin').classList.remove('hidden');
            
            // Set Premium Badge
            const isPrem = localStorage.getItem('adminPremium') === 'true';
            const badge = document.getElementById('plan-badge');
            if (isPrem) {
                badge.className = "inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold bg-amber-100 text-amber-700 border border-amber-200";
                badge.innerHTML = '<i data-lucide="crown" class="w-3.5 h-3.5"></i> Premium';
            } else {
                badge.className = "inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold bg-slate-100 text-slate-600 border border-slate-200";
                badge.innerHTML = '<i data-lucide="package" class="w-3.5 h-3.5"></i> Free Plan';
            }

            renderAdminPage('dashboard');
            fetchAdminData();
            setTimeout(() => { if (typeof lucide !== 'undefined') lucide.createIcons(); }, 50);
        }

        function toggleSidebar(forceState) {
            const sidebar = document.getElementById('admin-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (typeof forceState !== 'undefined') isSidebarOpen = forceState;
            else isSidebarOpen = !isSidebarOpen;

            if (isSidebarOpen) { sidebar.classList.remove('-translate-x-full'); overlay.classList.remove('hidden'); } 
            else { sidebar.classList.add('-translate-x-full'); overlay.classList.add('hidden'); }
        }

        function renderAdminPage(viewId) {
            // Sidebar Active State
            const btnDash = document.getElementById('nav-dashboard');
            const btnPrem = document.getElementById('nav-premium');
            const activeClass = 'bg-slate-100 text-slate-900';
            const inactiveClass = 'text-slate-500 hover:bg-slate-50 hover:text-slate-900';

            btnDash.className = `w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium transition ${viewId === 'dashboard' ? activeClass : inactiveClass}`;
            btnPrem.className = `w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium transition ${viewId === 'premium' ? activeClass : inactiveClass}`;

            document.getElementById('admin-view-dashboard').classList.add('hidden');
            document.getElementById('admin-view-premium').classList.add('hidden');
            document.getElementById(`admin-view-${viewId}`).classList.remove('hidden');

            if (viewId === 'premium') initPremiumPage();
        }

        // --- PREMIUM FEATURES LOGIC ---
        function initPremiumPage() {
            const isPremium = localStorage.getItem('adminPremium') === 'true';
            const overlay = document.getElementById('premium-overlay');
            const msg = document.getElementById('premium-locked-msg');
            
            if (isPremium) {
                overlay.classList.add('hidden');
                msg.classList.add('hidden');
            } else {
                overlay.classList.remove('hidden');
                msg.classList.remove('hidden');
            }
        }

        document.getElementById('support-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msg = document.getElementById('support-msg').value;
            const btn = document.getElementById('btn-send-support');
            
            if (!msg.trim()) return;

            btn.disabled = true;
            btn.innerText = "Mengirim...";
            
            try {
                // Get current admin username for context (stored in login or fetch from DB? Simplifying here)
                const username = "Admin Sekolah"; 
                
                const { error } = await _supabase.from('support_messages').insert({
                    admin_username: username,
                    message: msg
                });

                if (error) throw error;
                alert("Pesan terkirim ke developer! Terima kasih.");
                document.getElementById('support-msg').value = "";
            } catch (err) {
                alert("Gagal mengirim pesan: " + err.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "Kirim Pesan";
            }
        });

        // --- LOGIN LOGIC ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Turnstile Check
            if (loginWidgetId !== null) {
                const turnstileResponse = turnstile.getResponse(loginWidgetId);
                if (!turnstileResponse) {
                    document.getElementById('login-error-text').innerText = "Silakan selesaikan verifikasi keamanan.";
                    document.getElementById('login-error').classList.remove('hidden');
                    return;
                }
            }

            const u = document.getElementById('login-username').value;
            const p = document.getElementById('login-password').value;
            const btn = document.getElementById('btn-login');
            const txt = document.getElementById('btn-login-text');
            const load = document.getElementById('btn-login-loader');
            const errDiv = document.getElementById('login-error');

            btn.disabled = true; txt.innerText = "Memproses...";
            load.classList.remove('hidden'); errDiv.classList.add('hidden');

            try {
                const { data, error } = await _supabase
                    .from(SUPABASE_ADMIN_TABLE)
                    .select('*')
                    .eq('username', u)
                    .eq('password', p)
                    .single();

                if (error || !data) throw new Error('Username atau password salah.');
                
                localStorage.setItem('adminToken', 'true');
                localStorage.setItem('adminPremium', data.is_premium ? 'true' : 'false');
                
                showAdminDashboard();
                document.getElementById('login-username').value = '';
                document.getElementById('login-password').value = '';
                if(loginWidgetId) turnstile.reset(loginWidgetId);
            } catch (err) {
                document.getElementById('login-error-text').innerText = err.message;
                errDiv.classList.remove('hidden');
                if(loginWidgetId) turnstile.reset(loginWidgetId);
            } finally {
                btn.disabled = false; txt.innerText = "Masuk Dashboard"; load.classList.add('hidden');
            }
        });

        function handleLogout() {
            if(confirm("Logout?")) { 
                localStorage.removeItem('adminToken'); 
                localStorage.removeItem('adminPremium');
                showLoginPage();
            }
        }

        // --- ADMIN DATA LOGIC ---
        async function fetchAdminData() {
            const loader = document.getElementById('admin-loading');
            const empty = document.getElementById('admin-empty');
            const refreshIcon = document.getElementById('refresh-icon');

            if(refreshIcon) refreshIcon.classList.add('animate-spin');
            if(loader) loader.classList.remove('hidden');
            if(empty) empty.classList.add('hidden');
            document.getElementById('admin-tbody').innerHTML = '';

            try {
                const { data, error } = await _supabase.from(SUPABASE_TABLE).select('*').order('tanggal', { ascending: false });
                if (error) throw error;
                adminData = data;
                renderAdminTable(data);
                calculateStats(data);
            } catch (err) { console.error(err); } 
            finally {
                if(loader) loader.classList.add('hidden');
                if(refreshIcon) refreshIcon.classList.remove('animate-spin');
                if (adminData.length === 0 && empty) empty.classList.remove('hidden');
            }
        }

        function calculateStats(data) {
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            const monthStr = now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, '0');
            const setText = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };
            setText('stat-total', data.length);
            setText('stat-today', data.filter(i => i.tanggal && i.tanggal.startsWith(todayStr)).length);
            setText('stat-month', data.filter(i => i.tanggal && i.tanggal.startsWith(monthStr)).length);
            setText('stat-photo', data.filter(i => i.image_url).length);
            setText('stat-sign', data.filter(i => i.signature_url).length);
        }

        function renderAdminTable(data) {
            const tbody = document.getElementById('admin-tbody');
            tbody.innerHTML = '';
            data.forEach(item => {
                const dateObj = new Date(item.tanggal);
                const dateStr = dateObj.toLocaleString('id-ID', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition border-b border-slate-100 last:border-0";
                
                let imgHtml = item.image_url ? `<a href="${item.image_url}" target="_blank" class="w-9 h-9 rounded-lg bg-slate-100 block overflow-hidden border border-slate-200 hover:ring-2 hover:ring-blue-400 transition"><img src="${item.image_url}" class="w-full h-full object-cover"></a>` : `<div class="w-9 h-9 rounded-lg bg-slate-50 flex items-center justify-center border border-slate-200"><i data-lucide="image-off" class="w-4 h-4 text-slate-300"></i></div>`;
                let signHtml = item.signature_url ? `<a href="${item.signature_url}" target="_blank" class="w-9 h-9 rounded-lg bg-white block p-1 border border-slate-200 hover:ring-2 hover:ring-blue-400 transition"><img src="${item.signature_url}" class="w-full h-full object-contain"></a>` : `<div class="w-9 h-9 rounded-lg bg-slate-50 flex items-center justify-center border border-slate-200"><i data-lucide="pen-tool" class="w-4 h-4 text-slate-300"></i></div>`;

                tr.innerHTML = `
                    <td class="p-4"><div class="font-bold text-slate-800">${item.nama || 'Tanpa Nama'}</div><div class="text-xs text-slate-500 font-medium">${item.instansi || '-'}</div></td>
                    <td class="p-4 hidden sm:table-cell text-sm text-slate-600 truncate max-w-[150px]">${item.maksud || '-'}</td>
                    <td class="p-4 hidden md:table-cell"><span class="px-2 py-1 bg-slate-100 rounded text-xs font-medium text-slate-600 border border-slate-200 whitespace-nowrap">${dateStr}</span></td>
                    <td class="p-4 text-center"><div class="flex justify-center gap-2">${imgHtml}${signHtml}</div></td>
                    <td class="p-4 text-right"><div class="flex justify-end gap-2"><button onclick="openDetailModal('${item.id}')" class="p-2 bg-white border border-slate-200 rounded-lg text-slate-400 hover:text-blue-600 hover:bg-blue-50 transition shadow-sm"><i data-lucide="eye" class="w-4 h-4"></i></button><button onclick="confirmDelete('${item.id}')" class="p-2 bg-white border border-slate-200 rounded-lg text-slate-400 hover:text-red-600 hover:bg-red-50 transition shadow-sm"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></td>
                `;
                tbody.appendChild(tr);
            });
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function filterAdminData() {
            const term = document.getElementById('admin-search').value.toLowerCase();
            renderAdminTable(adminData.filter(item => (item.nama || '').toLowerCase().includes(term) || (item.instansi || '').toLowerCase().includes(term)));
        }

        // --- DETAIL & DELETE MODALS ---
        function openDetailModal(id) {
            const item = adminData.find(d => d.id == id);
            if (!item) return;
            document.getElementById('detail-nama').innerText = item.nama || '-';
            document.getElementById('detail-instansi').innerText = item.instansi || '-';
            document.getElementById('detail-maksud').innerText = item.maksud || '-';
            document.getElementById('detail-pesan').innerText = item.tujuan || '-';
            const dateObj = new Date(item.tanggal);
            document.getElementById('detail-waktu').innerText = dateObj.toLocaleString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            
            const imgEl = document.getElementById('detail-img');
            imgEl.src = item.image_url || "https://placehold.co/400x300?text=No+Photo";
            const signEl = document.getElementById('detail-sign');
            if (item.signature_url) { signEl.src = item.signature_url; signEl.parentElement.classList.remove('hidden'); }
            else { signEl.src = ""; signEl.parentElement.classList.add('hidden'); }
            document.getElementById('detail-modal').classList.remove('hidden');
        }

        function closeDetailModal() { document.getElementById('detail-modal').classList.add('hidden'); }
        function confirmDelete(id) { idToDelete = id; document.getElementById('delete-modal').classList.remove('hidden'); }
        function closeDeleteModal() { idToDelete = null; document.getElementById('delete-modal').classList.add('hidden'); }

        async function executeDelete() {
            if (!idToDelete) return;
            const btn = document.getElementById('btn-confirm-delete');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<div class="loader w-4 h-4 border-white border-t-transparent"></div>`; btn.disabled = true;
            try {
                const { error } = await _supabase.from(SUPABASE_TABLE).delete().eq('id', idToDelete);
                if (error) throw error;
                adminData = adminData.filter(i => i.id !== idToDelete);
                renderAdminTable(adminData); calculateStats(adminData);
                if(document.getElementById('admin-search').value) filterAdminData();
            } catch (err) { alert("Gagal menghapus: " + err.message); } 
            finally { btn.innerHTML = originalText; btn.disabled = false; closeDeleteModal(); }
        }

        function exportCSV() {
            if (adminData.length === 0) return;
            const headers = ["ID", "Nama", "Instansi", "Maksud", "Pesan", "Tanggal", "Image URL", "Signature URL"];
            const csvRows = [headers.join(",")];
            adminData.forEach(item => {
                csvRows.push([item.id, `"${item.nama||''}"`, `"${item.instansi||''}"`, `"${item.maksud||''}"`, `"${item.tujuan||''}"`, item.tanggal, item.image_url||'', item.signature_url||''].join(","));
            });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csvRows.join("\n")], { type: 'text/csv;charset=utf-8;' }));
            link.download = "buku_tamu_" + new Date().toISOString().split('T')[0] + ".csv";
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }
    </script>
</body>
</html>